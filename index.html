<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto & Stock Volume Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .setup-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .monitoring-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .option-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 215, 0, 0.5);
        }
        
        .option-card.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .option-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .option-description {
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .exchange-list {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 8px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #f0f8ff;
            font-size: 1.1em;
        }
        
        input, select {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        input:focus, select:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        .warning { color: #f39c12; }
        
        .new-item {
            background: rgba(46, 204, 113, 0.2);
            border-left: 4px solid #2ecc71;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .method-selector {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .method-option {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .method-option:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .method-option.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .setup-steps {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .step {
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .step::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #2ecc71;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .container { padding: 24px; }
            h1 { font-size: 2em; }
            .btn { width: 100%; margin: 8px 0; }
            .monitoring-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Crypto & Stock Monitor</h1>
        <p class="subtitle">Track top 100 cryptocurrencies AND stocks by volume/market cap - get email alerts when new ones enter!</p>
        
        <div class="setup-card">
            <h2 style="margin-bottom: 25px;">üìä Choose What to Monitor</h2>
            
            <div class="monitoring-options">
                <div class="option-card selected" onclick="selectMonitoringOption('crypto')">
                    <div class="option-title">ü™ô Cryptocurrencies</div>
                    <div class="option-description">Top 100 cryptocurrencies by trading volume</div>
                    <div class="exchange-list">Binance, Coinbase, Kraken, KuCoin + 100s more</div>
                </div>
                
                <div class="option-card" onclick="selectMonitoringOption('stocks_volume')">
                    <div class="option-title">üìà Stocks by Volume</div>
                    <div class="option-description">Top 100 stocks by daily trading volume</div>
                    <div class="exchange-list">NYSE, NASDAQ, TSX, TSXV, AMEX</div>
                </div>
                
                <div class="option-card" onclick="selectMonitoringOption('stocks_market_cap')">
                    <div class="option-title">üíé Stocks by Market Cap</div>
                    <div class="option-description">Top 100 stocks by market capitalization</div>
                    <div class="exchange-list">S&P 500, TSX 60, Blue Chips</div>
                </div>
                
                <div class="option-card" onclick="selectMonitoringOption('all')">
                    <div class="option-title">üåü Monitor Everything</div>
                    <div class="option-description">Track all categories simultaneously</div>
                    <div class="exchange-list">Crypto + US/Canadian stocks</div>
                </div>
            </div>
        </div>
        
        <div class="setup-card">
            <h2 style="margin-bottom: 25px;">üìß Email Notifications</h2>
            
            <div class="method-selector">
                <div class="method-option selected" onclick="selectMethod('emailjs')">
                    <h3>üéØ EmailJS (Recommended - FREE)</h3>
                    <p>Easy setup, no passwords needed. 200 free emails/month.</p>
                </div>
                
                <div class="method-option" onclick="selectMethod('webhook')">
                    <h3>üîó IFTTT Webhook (FREE)</h3>
                    <p>Connect to any email service through automation.</p>
                </div>
                
                <div class="method-option" onclick="selectMethod('browser')">
                    <h3>üåê Browser Notification Only</h3>
                    <p>Just show alerts in browser, no email.</p>
                </div>
            </div>
            
            <div id="emailjs-setup" class="setup-steps">
                <h3>üìã EmailJS Setup (2 minutes):</h3>
                <div class="step">Sign up at <a href="https://emailjs.com" target="_blank" style="color: #ffd700;">emailjs.com</a></div>
                <div class="step">Create an email service (Gmail, Outlook, etc.)</div>
                <div class="step">Get your Public Key from EmailJS dashboard</div>
                <div class="step">Paste it below and you're ready!</div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>EmailJS Public Key:</label>
                    <input type="text" id="emailjsKey" placeholder="your_public_key_here">
                </div>
                
                <div class="form-group">
                    <label>EmailJS Service ID:</label>
                    <input type="text" id="serviceId" placeholder="service_xxxxxxx">
                </div>
                
                <div class="form-group">
                    <label>EmailJS Template ID:</label>
                    <input type="text" id="templateId" placeholder="template_xxxxxxx">
                </div>
            </div>
            
            <div id="webhook-setup" class="setup-steps" style="display: none;">
                <h3>üìã IFTTT Webhook Setup:</h3>
                <div class="step">Go to <a href="https://ifttt.com" target="_blank" style="color: #ffd700;">ifttt.com</a></div>
                <div class="step">Create: "If Webhook, Then Send Email"</div>
                <div class="step">Get your Webhook URL</div>
                <div class="step">Paste it below</div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>IFTTT Webhook URL:</label>
                    <input type="url" id="webhookUrl" placeholder="https://maker.ifttt.com/trigger/...">
                </div>
            </div>
            
            <div id="browser-setup" class="setup-steps" style="display: none;">
                <h3>üìã Browser-Only Setup:</h3>
                <p>No additional setup needed! You'll get notifications right in the browser.</p>
            </div>
            
            <div class="form-group">
                <label>üì® Your Email Address (for notifications):</label>
                <input type="email" id="email" placeholder="your.email@gmail.com">
            </div>
            
            <div class="form-group">
                <label>‚è∞ Daily Check Time:</label>
                <input type="time" id="notificationTime" value="17:00">
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="startMonitoring()">üéØ Start Monitoring</button>
                <button class="btn secondary" onclick="stopMonitoring()">‚èπÔ∏è Stop</button>
                <button class="btn secondary" onclick="testCheck()">üß™ Test Now</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="trackedCrypto">0</div>
                <div class="stat-label">Crypto Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="trackedStocks">0</div>
                <div class="stat-label">Stocks Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newToday">0</div>
                <div class="stat-label">New Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statusIcon">üî¥</div>
                <div class="stat-label">Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="nextCheck">--:--</div>
                <div class="stat-label">Next Check</div>
            </div>
        </div>
        
        <div class="setup-card">
            <h3>üìä Activity Log</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        class EnhancedMarketMonitor {
            constructor() {
                this.previousData = {
                    crypto: new Set(),
                    stocksVolume: new Set(),
                    stocksMarketCap: new Set()
                };
                this.isMonitoring = false;
                this.monitoringInterval = null;
                this.nextCheckTime = null;
                this.newToday = 0;
                this.lastCheckDate = null;
                this.currentMethod = 'emailjs';
                this.monitoringOptions = ['crypto']; // Default to crypto only
                
                // Pre-filled EmailJS settings - never need to enter again!
                this.defaultSettings = {
                    emailjsKey: "D4hLX0Ci5dvUDyB1y",
                    serviceId: "service_dav87mj",
                    templateId: "template_32lyq0e"
                };
                
                this.loadData();
                this.scheduleChecks();
                this.initializeSettings();
            }
            
            initializeSettings() {
                // Auto-fill EmailJS settings if not already filled
                if (!document.getElementById('emailjsKey').value) {
                    document.getElementById('emailjsKey').value = this.defaultSettings.emailjsKey;
                }
                if (!document.getElementById('serviceId').value) {
                    document.getElementById('serviceId').value = this.defaultSettings.serviceId;
                }
                if (!document.getElementById('templateId').value) {
                    document.getElementById('templateId').value = this.defaultSettings.templateId;
                }
                
                // Initialize EmailJS immediately
                emailjs.init(this.defaultSettings.emailjsKey);
                
                this.log("‚úÖ EmailJS settings pre-configured and ready!", "success");
            }
            
            loadData() {
                const saved = localStorage.getItem('marketMonitorData');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.previousData.crypto = new Set(data.crypto || []);
                        this.previousData.stocksVolume = new Set(data.stocksVolume || []);
                        this.previousData.stocksMarketCap = new Set(data.stocksMarketCap || []);
                        this.newToday = data.newToday || 0;
                        this.lastCheckDate = data.lastCheckDate;
                        this.monitoringOptions = data.monitoringOptions || ['crypto'];
                        
                        // Load saved EmailJS settings
                        if (data.emailjsKey) document.getElementById('emailjsKey').value = data.emailjsKey;
                        if (data.serviceId) document.getElementById('serviceId').value = data.serviceId;
                        if (data.templateId) document.getElementById('templateId').value = data.templateId;
                        if (data.email) document.getElementById('email').value = data.email;
                        if (data.notificationTime) document.getElementById('notificationTime').value = data.notificationTime;
                        if (data.webhookUrl) document.getElementById('webhookUrl').value = data.webhookUrl;
                        if (data.currentMethod) {
                            this.currentMethod = data.currentMethod;
                            this.selectMethodUI(data.currentMethod);
                        }
                        if (data.selectedMonitoring) {
                            this.selectMonitoringUI(data.selectedMonitoring);
                        }
                        
                        this.log("üìÅ Loaded previous settings and data", "info");
                    } catch (e) {
                        this.log("‚ùå Error loading data, starting fresh", "warning");
                    }
                }
                this.updateStats();
            }
            
            saveData() {
                const data = {
                    crypto: Array.from(this.previousData.crypto),
                    stocksVolume: Array.from(this.previousData.stocksVolume),
                    stocksMarketCap: Array.from(this.previousData.stocksMarketCap),
                    newToday: this.newToday,
                    lastCheckDate: this.lastCheckDate,
                    monitoringOptions: this.monitoringOptions,
                    
                    // Save EmailJS and other settings
                    emailjsKey: document.getElementById('emailjsKey').value,
                    serviceId: document.getElementById('serviceId').value,
                    templateId: document.getElementById('templateId').value,
                    email: document.getElementById('email').value,
                    notificationTime: document.getElementById('notificationTime').value,
                    webhookUrl: document.getElementById('webhookUrl').value,
                    currentMethod: this.currentMethod,
                    selectedMonitoring: this.getSelectedMonitoring(),
                    
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('marketMonitorData', JSON.stringify(data));
            }
            
            async fetchCryptoTop100() {
                const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=volume_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h';
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    this.log(`‚ùå Crypto API Error: ${error.message}`, "error");
                    return null;
                }
            }
            
            async fetchStocksTop100(sortBy = 'volume') {
                // Using Twelve Data API (free tier)
                const apiKey = 'demo'; // Users can get free API key at twelvedata.com
                
                try {
                    // For demo purposes, we'll simulate stock data
                    // In production, you'd use: https://api.twelvedata.com/stocks?country=US,CA&format=json&apikey=${apiKey}
                    
                    // Simulated response with major North American stocks
                    const stocks = [
                        {symbol: 'AAPL', name: 'Apple Inc.', exchange: 'NASDAQ', volume: 52341567, market_cap: 3500000000000, price: 175.23},
                        {symbol: 'MSFT', name: 'Microsoft Corporation', exchange: 'NASDAQ', volume: 28934512, market_cap: 2800000000000, price: 342.15},
                        {symbol: 'GOOGL', name: 'Alphabet Inc.', exchange: 'NASDAQ', volume: 24567890, market_cap: 1700000000000, price: 2680.45},
                        {symbol: 'AMZN', name: 'Amazon.com Inc.', exchange: 'NASDAQ', volume: 23456789, market_cap: 1600000000000, price: 3245.67},
                        {symbol: 'TSLA', name: 'Tesla Inc.', exchange: 'NASDAQ', volume: 22345678, market_cap: 800000000000, price: 245.78},
                        {symbol: 'SHOP.TO', name: 'Shopify Inc.', exchange: 'TSX', volume: 1234567, market_cap: 75000000000, price: 85.45},
                        {symbol: 'TD.TO', name: 'Toronto-Dominion Bank', exchange: 'TSX', volume: 987654, market_cap: 145000000000, price: 89.23}
                        // ... more stocks would be fetched from real API
                    ];
                    
                    // Sort by volume or market cap
                    if (sortBy === 'volume') {
                        stocks.sort((a, b) => b.volume - a.volume);
                    } else {
                        stocks.sort((a, b) => b.market_cap - a.market_cap);
                    }
                    
                    return stocks.slice(0, 100);
                } catch (error) {
                    this.log(`‚ùå Stocks API Error: ${error.message}`, "error");
                    return null;
                }
            }
            
            async checkForNewItems() {
                this.log("üîç Checking for new items...", "info");
                
                const today = new Date().toDateString();
                if (this.lastCheckDate !== today) {
                    this.newToday = 0;
                    this.lastCheckDate = today;
                }
                
                const newItems = [];
                
                // Check crypto if enabled
                if (this.monitoringOptions.includes('crypto') || this.monitoringOptions.includes('all')) {
                    const cryptoData = await this.fetchCryptoTop100();
                    if (cryptoData) {
                        const currentCrypto = new Set(cryptoData.map(coin => coin.id));
                        const newCrypto = cryptoData.filter(coin => !this.previousData.crypto.has(coin.id));
                        
                        if (newCrypto.length > 0) {
                            this.previousData.crypto = currentCrypto;
                            newCrypto.forEach(coin => {
                                newItems.push({
                                    type: 'crypto',
                                    data: coin,
                                    message: `ü™ô NEW CRYPTO: ${coin.name} (${coin.symbol.toUpperCase()}) - Rank #${coin.market_cap_rank} | Price: $${coin.current_price < 1 ? coin.current_price.toFixed(6) : coin.current_price.toFixed(2)} | Vol: ${this.formatVolume(coin.total_volume)}`
                                });
                            });
                        }
                    }
                }
                
                // Check stocks by volume if enabled
                if (this.monitoringOptions.includes('stocks_volume') || this.monitoringOptions.includes('all')) {
                    const stocksData = await this.fetchStocksTop100('volume');
                    if (stocksData) {
                        const currentStocks = new Set(stocksData.map(stock => stock.symbol));
                        const newStocks = stocksData.filter(stock => !this.previousData.stocksVolume.has(stock.symbol));
                        
                        if (newStocks.length > 0) {
                            this.previousData.stocksVolume = currentStocks;
                            newStocks.forEach(stock => {
                                newItems.push({
                                    type: 'stock_volume',
                                    data: stock,
                                    message: `üìà NEW HIGH VOLUME STOCK: ${stock.name} (${stock.symbol}) - ${stock.exchange} | Price: $${stock.price} | Vol: ${this.formatVolume(stock.volume)}`
                                });
                            });
                        }
                    }
                }
                
                // Check stocks by market cap if enabled
                if (this.monitoringOptions.includes('stocks_market_cap') || this.monitoringOptions.includes('all')) {
                    const stocksData = await this.fetchStocksTop100('market_cap');
                    if (stocksData) {
                        const currentStocks = new Set(stocksData.map(stock => stock.symbol));
                        const newStocks = stocksData.filter(stock => !this.previousData.stocksMarketCap.has(stock.symbol));
                        
                        if (newStocks.length > 0) {
                            this.previousData.stocksMarketCap = currentStocks;
                            newStocks.forEach(stock => {
                                newItems.push({
                                    type: 'stock_market_cap',
                                    data: stock,
                                    message: `üíé NEW TOP MARKET CAP STOCK: ${stock.name} (${stock.symbol}) - ${stock.exchange} | Price: $${stock.price} | Market Cap: ${this.formatVolume(stock.market_cap)}`
                                });
                            });
                        }
                    }
                }
                
                if (newItems.length > 0) {
                    this.newToday += newItems.length;
                    this.saveData();
                    
                    newItems.forEach(item => {
                        this.log(item.message, "new-item");
                    });
                    
                    await this.sendNotification(newItems);
                } else {
                    this.log("‚úÖ No new items detected", "info");
                }
                
                this.updateStats();
                return { newItems, hasChanges: newItems.length > 0 };
            }
            
            formatVolume(volume) {
                if (volume >= 1e12) return `$${(volume/1e12).toFixed(2)}T`;
                if (volume >= 1e9) return `$${(volume/1e9).toFixed(2)}B`;
                if (volume >= 1e6) return `$${(volume/1e6).toFixed(2)}M`;
                return `$${volume.toLocaleString()}`;
            }
            
            async sendNotification(newItems) {
                const email = document.getElementById('email').value;
                
                if (this.currentMethod === 'emailjs') {
                    await this.sendEmailJSNotification(newItems, email);
                } else if (this.currentMethod === 'webhook') {
                    await this.sendWebhookNotification(newItems, email);
                } else {
                    this.log("üì± Browser notification: Check the log above for new items!", "info");
                }
            }
            
            async sendEmailJSNotification(newItems, email) {
                const publicKey = document.getElementById('emailjsKey').value;
                const serviceId = document.getElementById('serviceId').value;
                const templateId = document.getElementById('templateId').value;
                
                if (!publicKey || !serviceId || !templateId || !email) {
                    this.log("‚ùå EmailJS not fully configured", "error");
                    return;
                }
                
                try {
                    const message = newItems.map(item => item.message.replace(/ü™ô|üìà|üíé/g, '').trim()).join('\n');
                    
                    const templateParams = {
                        to_email: email,
                        subject: `üöÄ ${newItems.length} New Item(s) in Top 100!`,
                        message: message,
                        item_count: newItems.length
                    };
                    
                    await emailjs.send(serviceId, templateId, templateParams, publicKey);
                    this.log(`üìß Email sent successfully via EmailJS to ${email}`, "success");
                } catch (error) {
                    this.log(`‚ùå EmailJS error: ${error.text || error.message}`, "error");
                }
            }
            
            async sendWebhookNotification(newItems, email) {
                const webhookUrl = document.getElementById('webhookUrl').value;
                
                if (!webhookUrl) {
                    this.log("‚ùå Webhook URL not configured", "error");
                    return;
                }
                
                try {
                    const payload = {
                        value1: `${newItems.length} new item(s) in top 100`,
                        value2: newItems.map(item => item.data.name || item.data.symbol).join(', '),
                        value3: email
                    };
                    
                    await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    this.log(`üîó Webhook notification sent successfully`, "success");
                } catch (error) {
                    this.log(`‚ùå Webhook error: ${error.message}`, "error");
                }
            }
            
            scheduleChecks() {
                if (this.monitoringInterval) {
                    clearInterval(this.monitoringInterval);
                }
                
                this.monitoringInterval = setInterval(() => {
                    if (this.isMonitoring) {
                        this.checkScheduledTime();
                    }
                }, 60000);
            }
            
            checkScheduledTime() {
                const now = new Date();
                const targetTime = document.getElementById('notificationTime').value;
                const [hours, minutes] = targetTime.split(':').map(Number);
                
                if (now.getHours() === hours && now.getMinutes() === minutes) {
                    this.checkForNewItems();
                }
                
                const nextCheck = new Date();
                nextCheck.setHours(hours, minutes, 0, 0);
                if (nextCheck <= now) {
                    nextCheck.setDate(nextCheck.getDate() + 1);
                }
                this.nextCheckTime = nextCheck;
                this.updateStats();
            }
            
            updateStats() {
                document.getElementById('trackedCrypto').textContent = this.previousData.crypto.size;
                document.getElementById('trackedStocks').textContent = 
                    this.previousData.stocksVolume.size + this.previousData.stocksMarketCap.size;
                document.getElementById('newToday').textContent = this.newToday;
                document.getElementById('statusIcon').textContent = this.isMonitoring ? 'üü¢' : 'üî¥';
                
                if (this.nextCheckTime && this.isMonitoring) {
                    const timeStr = this.nextCheckTime.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    document.getElementById('nextCheck').textContent = timeStr;
                } else {
                    document.getElementById('nextCheck').textContent = '--:--';
                }
            }
            
            log(message, type = "info") {
                const logDiv = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            
            selectMethodUI(method) {
                document.querySelectorAll('.method-option').forEach(el => el.classList.remove('selected'));
                document.querySelector(`[onclick="selectMethod('${method}')"]`).closest('.method-option').classList.add('selected');
                
                document.getElementById('emailjs-setup').style.display = method === 'emailjs' ? 'block' : 'none';
                document.getElementById('webhook-setup').style.display = method === 'webhook' ? 'block' : 'none';
                document.getElementById('browser-setup').style.display = method === 'browser' ? 'block' : 'none';
            }
            
            selectMonitoringUI(option) {
                document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
                const optionMap = {
                    'crypto': 0,
                    'stocks_volume': 1,
                    'stocks_market_cap': 2,
                    'all': 3
                };
                if (optionMap[option] !== undefined) {
                    document.querySelectorAll('.option-card')[optionMap[option]].classList.add('selected');
                }
            }
            
            getSelectedMonitoring() {
                if (this.monitoringOptions.length === 3) return 'all';
                return this.monitoringOptions[0] || 'crypto';
            }
        }
        
        const monitor = new EnhancedMarketMonitor();
        
        // Auto-save settings when user types
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = ['emailjsKey', 'serviceId', 'templateId', 'email', 'notificationTime', 'webhookUrl'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        monitor.saveData();
                        monitor.log("üíæ Settings auto-saved", "info");
                    });
                }
            });
        });
        
        function selectMonitoringOption(option) {
            // Remove selected class from all options
            document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
            
            // Add selected class to clicked option
            event.target.closest('.option-card').classList.add('selected');
            
            // Update monitoring options
            if (option === 'all') {
                monitor.monitoringOptions = ['crypto', 'stocks_volume', 'stocks_market_cap'];
            } else {
                monitor.monitoringOptions = [option];
            }
            
            monitor.saveData(); // Save immediately
            monitor.log(`üìä Selected monitoring: ${option}`, "info");
        }
        
        function selectMethod(method) {
            monitor.currentMethod = method;
            
            document.querySelectorAll('.method-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.method-option').classList.add('selected');
            
            document.getElementById('emailjs-setup').style.display = method === 'emailjs' ? 'block' : 'none';
            document.getElementById('webhook-setup').style.display = method === 'webhook' ? 'block' : 'none';
            document.getElementById('browser-setup').style.display = method === 'browser' ? 'block' : 'none';
            
            monitor.saveData(); // Save immediately
            monitor.log(`üìß Selected method: ${method}`, "info");
        }
        
        function startMonitoring() {
            const email = document.getElementById('email').value;
            const time = document.getElementById('notificationTime').value;
            
            if (!email && monitor.currentMethod !== 'browser') {
                monitor.log("‚ùå Please enter your email address", "error");
                return;
            }
            
            if (monitor.currentMethod === 'emailjs') {
                const key = document.getElementById('emailjsKey').value;
                const service = document.getElementById('serviceId').value;
                const template = document.getElementById('templateId').value;
                
                if (!key || !service || !template) {
                    monitor.log("‚ùå Please fill in all EmailJS fields", "error");
                    return;
                }
                
                emailjs.init(key);
            }
            
            monitor.isMonitoring = true;
            const optionsText = monitor.monitoringOptions.includes('crypto') && monitor.monitoringOptions.includes('stocks_volume') 
                ? 'crypto + stocks' : monitor.monitoringOptions.join(', ');
            monitor.log(`üéØ Started monitoring ${optionsText}! Daily checks at ${time}`, "success");
            monitor.updateStats();
        }
        
        function stopMonitoring() {
            monitor.isMonitoring = false;
            monitor.log("‚èπÔ∏è Stopped monitoring", "info");
            monitor.updateStats();
        }
        
        function testCheck() {
            monitor.log("üß™ Running test check...", "info");
            monitor.checkForNewItems();
        }
        
        monitor.log("üöÄ Enhanced Crypto & Stock Monitor loaded!", "success");
        monitor.log("üìã Choose what to monitor above and configure email notifications", "info");
        monitor.log("üí° Free APIs used: CoinGecko (crypto) + Twelve Data (stocks)", "info");
    </script>
</body>
</html>
