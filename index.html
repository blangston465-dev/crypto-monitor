<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Market Monitor Pro</title>
  <style>
    /* --- same CSS as before, unchanged --- */
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ Dark Mode</button>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸš€ Market Monitor Pro</h1>
      <p class="subtitle">Live crypto & stocks with 7-day history</p>
    </div>

    <!-- Main grid -->
    <div class="main-grid">
      <div class="setup-card">
        <h2 class="card-title">ğŸ“Š Configuration</h2>
        <h3 style="margin-bottom:15px;color:white">Choose What to Monitor</h3>
        <div class="monitoring-options">
          <div class="option-card selected" onclick="selectMonitoringOption('crypto', this)">
            <div class="option-title">ğŸª™ Cryptocurrencies</div>
            <div class="option-description">Top 100 by volume</div>
          </div>
          <div class="option-card" onclick="selectMonitoringOption('stocks_volume', this)">
            <div class="option-title">ğŸ“ˆ Stocks by Volume</div>
            <div class="option-description">Yahoo â€œMost Activesâ€ (100)</div>
          </div>
          <div class="option-card" onclick="selectMonitoringOption('stocks_market_cap', this)">
            <div class="option-title">ğŸ’ Stocks by Market Cap</div>
            <div class="option-description">Yahoo â€œMega Capâ€ (100)</div>
          </div>
          <div class="option-card" onclick="selectMonitoringOption('all', this)">
            <div class="option-title">ğŸŒŸ Everything</div>
            <div class="option-description">All categories</div>
          </div>
        </div>

        <div class="form-group">
          <label>ğŸ“¨ Your Email Address:</label>
          <input type="email" id="email" placeholder="your.email@gmail.com"/>
        </div>

        <div class="form-group">
          <label>â° Daily Check Time:</label>
          <input type="time" id="notificationTime" value="17:00"/>
        </div>

        <div style="text-align:center;margin-top:25px">
          <button class="btn" onclick="startMonitoring()">ğŸ¯ Start Monitoring</button>
          <button class="btn secondary" onclick="stopMonitoring()">â¹ï¸ Stop</button>
          <button class="btn secondary" onclick="testCheck()">ğŸ§ª Test Now</button>
        </div>
      </div>

      <div class="live-tracker">
        <div class="tracker-header">
          <h2 class="card-title" style="margin:0">ğŸ“ˆ 7-Day Live Tracker</h2>
          <button class="refresh-btn" onclick="refreshLiveTracker()">ğŸ”„ Refresh</button>
        </div>
        <div id="liveTrackerContent">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <p>No new entries in the last 7 days</p>
            <p style="font-size:.8em;margin-top:5px">Run a test check to see how this works!</p>
          </div>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card"><div class="stat-number" id="trackedCrypto">0</div><div class="stat-label">Crypto Tracked</div></div>
      <div class="stat-card"><div class="stat-number" id="trackedStocks">0</div><div class="stat-label">Stocks Tracked</div></div>
      <div class="stat-card"><div class="stat-number" id="newToday">0</div><div class="stat-label">New Today</div></div>
      <div class="stat-card"><div class="stat-number" id="sevenDayTotal">0</div><div class="stat-label">7-Day Total</div></div>
      <div class="stat-card"><div class="stat-number" id="statusIcon">ğŸ”´</div><div class="stat-label">Status</div></div>
      <div class="stat-card"><div class="stat-number" id="nextCheck">--:--</div><div class="stat-label">Next Check</div></div>
    </div>

    <div class="setup-card">
      <h3 class="card-title">ğŸ“Š Activity Log</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    var monitor;

    function AdvancedMarketMonitor(){
      this.previousData = { crypto:new Set(), stocksVolume:new Set(), stocksMarketCap:new Set() };
      this.isMonitoring = false;
      this.monitoringInterval = null;
      this.nextCheckTime = null;
      this.newToday = 0;
      this.lastCheckDate = null;
      this.monitoringOptions = ['crypto'];
      this.sevenDayHistory = [];
      this.defaultSettings = { emailjsKey:"D4hLX0Ci5dvUDyB1y", serviceId:"service_dav87mj", templateId:"template_32lyq0e" };
      this.yahooProxy = "https://api.allorigins.win/raw?url=";

      this.loadData();
      this.scheduleChecks();
      this.initializeEmail();
      this.updateLiveTracker();
    }

    AdvancedMarketMonitor.prototype.initializeEmail = function(){
      try{ emailjs.init(this.defaultSettings.emailjsKey); this.log("âœ… EmailJS ready","success"); }
      catch(e){ this.log("âŒ EmailJS init failed: "+e.message,"error"); }
    };

    AdvancedMarketMonitor.prototype.loadData = function(){
      var saved = localStorage.getItem('advancedMarketMonitorData');
      if(saved){
        try{
          var data = JSON.parse(saved);
          this.previousData.crypto = new Set(data.crypto || []);
          this.previousData.stocksVolume = new Set(data.stocksVolume || []);
          this.previousData.stocksMarketCap = new Set(data.stocksMarketCap || []);
          this.newToday = data.newToday || 0;
          this.lastCheckDate = data.lastCheckDate;
          this.monitoringOptions = data.monitoringOptions || ['crypto'];
          this.sevenDayHistory = data.sevenDayHistory || [];
          if(data.email) document.getElementById('email').value = data.email;
          if(data.notificationTime) document.getElementById('notificationTime').value = data.notificationTime;
          this.cleanOldHistory();
          this.log("ğŸ“ Loaded saved state","info");
        }catch(e){ this.log("âŒ Load error, starting fresh","warning"); }
      }
      this.updateStats();
    };

    AdvancedMarketMonitor.prototype.saveData = function(){
      var data = {
        crypto: Array.from(this.previousData.crypto),
        stocksVolume: Array.from(this.previousData.stocksVolume),
        stocksMarketCap: Array.from(this.previousData.stocksMarketCap),
        newToday: this.newToday,
        lastCheckDate: this.lastCheckDate,
        monitoringOptions: this.monitoringOptions,
        sevenDayHistory: this.sevenDayHistory,
        email: document.getElementById('email').value,
        notificationTime: document.getElementById('notificationTime').value,
        ts: new Date().toISOString()
      };
      localStorage.setItem('advancedMarketMonitorData', JSON.stringify(data));
    };

    AdvancedMarketMonitor.prototype.cleanOldHistory = function(){
      var cutoff = new Date(); cutoff.setDate(cutoff.getDate()-7);
      this.sevenDayHistory = this.sevenDayHistory.filter(function(i){ return new Date(i.timestamp) > cutoff; });
    };

    /* --- Data fetching --- */
    AdvancedMarketMonitor.prototype.fetchCryptoTop100 = function(){
      var url='https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=volume_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h';
      var self=this;
      return fetch(url).then(r=>r.ok?r.json():Promise.reject('HTTP '+r.status))
        .catch(err=>{ self.log('âŒ Crypto API: '+err,'error'); return null; });
    };

    AdvancedMarketMonitor.prototype.fetchYahooPredefined = function(scrId){
      var url = 'https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?formatted=false&scrIds=' + encodeURIComponent(scrId) + '&count=100';
      var proxied = this.yahooProxy + encodeURIComponent(url);
      var self=this;
      return fetch(proxied)
        .then(r=>r.ok?r.json():Promise.reject('HTTP '+r.status))
        .then(data=>{
          var quotes = data?.finance?.result?.[0]?.quotes || [];
          return quotes.slice(0,100).map(q=>({
            symbol: q.symbol || '',
            name: q.longName || q.shortName || q.symbol || '',
            exchange: q.fullExchangeName || q.exchange || 'â€”',
            volume: Number(q.regularMarketVolume || q.averageDailyVolume3Month || 0),
            market_cap: Number(q.marketCap || 0),
            price: Number(q.regularMarketPrice || 0)
          }));
        })
        .catch(err=>{ self.log('âŒ Yahoo fetch error: '+err,'error'); return null; });
    };

    AdvancedMarketMonitor.prototype.fetchStocksTop100 = function(sortBy){
      var scrId = (sortBy === 'volume') ? 'most_actives' : 'mega_cap';
      return this.fetchYahooPredefined(scrId).then(list=>{
        if(list && list.length) return list;
        // Fallback mock data
        return [
          {symbol:'AAPL',name:'Apple Inc.',exchange:'NASDAQ',volume:52341567,market_cap:3500000000000,price:175.23},
          {symbol:'MSFT',name:'Microsoft',exchange:'NASDAQ',volume:28934512,market_cap:2800000000000,price:342.15}
        ];
      });
    };

    /* --- Helpers --- */
    AdvancedMarketMonitor.prototype.formatVolume = function(v){
      if(v==null||isNaN(v)) return '-';
      if(v>=1e12) return (v/1e12).toFixed(2)+'T';
      if(v>=1e9)  return (v/1e9).toFixed(2)+'B';
      if(v>=1e6)  return (v/1e6).toFixed(2)+'M';
      if(v>=1e3)  return (v/1e3).toFixed(1)+'K';
      return Number(v).toLocaleString();
    };

    AdvancedMarketMonitor.prototype.getTimeAgo = function(d){
      var now=new Date(), ms=now-d, m=Math.floor(ms/60000), h=Math.floor(ms/3600000), day=Math.floor(ms/86400000);
      if(m<1) return 'Just now'; if(m<60) return m+'m ago'; if(h<24) return h+'h ago'; if(day===1) return 'Yesterday'; return day+' days ago';
    };

    AdvancedMarketMonitor.prototype.updateStats = function(){
      document.getElementById('trackedCrypto').textContent = this.previousData.crypto.size;
      document.getElementById('trackedStocks').textContent = this.previousData.stocksVolume.size + this.previousData.stocksMarketCap.size;
      document.getElementById('newToday').textContent = this.newToday;
      document.getElementById('sevenDayTotal').textContent = this.sevenDayHistory.length;
      document.getElementById('statusIcon').textContent = this.isMonitoring ? 'ğŸŸ¢' : 'ğŸ”´';
      document.getElementById('nextCheck').textContent = (this.nextCheckTime && this.isMonitoring) ?
        this.nextCheckTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}) : '--:--';
    };

    AdvancedMarketMonitor.prototype.updateLiveTracker = function(){
      var container=document.getElementById('liveTrackerContent');
      this.cleanOldHistory();
      if(this.sevenDayHistory.length===0){
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>No new entries in the last 7 days</p><p style="font-size:.8em;margin-top:5px">Run a test check to see how this works!</p></div>`;
        return;
      }
      var self=this;
      container.innerHTML=this.sevenDayHistory.slice().sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))
        .map(item=>{
          var d=new Date(item.timestamp);
          var priceStr=item.price<1 ? item.price.toFixed(6) : item.price.toFixed(2);
          var volStr=self.formatVolume(item.volume||item.market_cap);
          return `<div class="entry-item"><div class="entry-header"><div class="entry-name">${item.name} (${item.symbol})</div><div class="entry-type ${item.type}">${item.category}</div></div><div class="entry-details"><strong>Exchange:</strong> ${item.exchange} | <strong>Price:</strong> ${priceStr} | <strong>Volume:</strong> ${volStr}</div><div class="entry-time">${self.getTimeAgo(d)} â€¢ ${d.toLocaleDateString()} at ${d.toLocaleTimeString()}</div></div>`;
        }).join('');
    };

    AdvancedMarketMonitor.prototype.log = function(msg,type){
      var logDiv=document.getElementById('log');
      var timestamp=new Date().toLocaleTimeString();
      var entry=document.createElement('div');
      entry.className='log-entry '+(type||'info');
      entry.innerHTML='<strong>['+timestamp+']</strong> '+msg;
      logDiv.appendChild(entry);
      logDiv.scrollTop=logDiv.scrollHeight;
    };

    AdvancedMarketMonitor.prototype.scheduleChecks = function(){
      var self=this;
      if(this.monitoringInterval) clearInterval(this.monitoringInterval);
      this.monitoringInterval=setInterval(function(){ if(self.isMonitoring) self.checkScheduledTime(); },60000);
    };

    AdvancedMarketMonitor.prototype.checkScheduledTime = function(){
      var now=new Date();
      var target=document.getElementById('notificationTime').value || '17:00';
      var parts=target.split(':'), hours=parseInt(parts[0],10), minutes=parseInt(parts[1],10);
      if(now.getHours()===hours && now.getMinutes()===minutes){ this.checkForNewItems(); }
      var next=new Date(); next.setHours(hours,minutes,0,0); if(next<=now) next.setDate(next.getDate()+1);
      this.nextCheckTime=next; this.updateStats();
    };

    /* --- Core check --- */
    AdvancedMarketMonitor.prototype.checkForNewItems = async function(){
      var self=this, newItems=[];
      var today=(new Date()).toDateString();
      if(this.lastCheckDate!==today){ this.newToday=0; this.lastCheckDate=today; }

      if(this.monitoringOptions.includes('crypto') || this.monitoringOptions.includes('all')){
        var crypto=await this.fetchCryptoTop100();
        if(crypto){
          var currentSymbols=new Set(crypto.map(c=>String(c.symbol||'').toUpperCase()));
          crypto.forEach(function(c){
            var sym=String(c.symbol||'').toUpperCase();
            if(sym && !self.previousData.crypto.has(sym)){
              newItems.push({type:'crypto',category:'Crypto',name:c.name,symbol:sym,exchange:'Multiple',price:Number(c.current_price||0),volume:Number(c.total_volume||0),market_cap:Number(c.market_cap||0),rank:c.market_cap_rank,timestamp:new Date().toISOString()});
            }
          });
          self.previousData.crypto=currentSymbols;
        }
      }

      if(this.monitoringOptions.includes('stocks_volume') || this.monitoringOptions.includes('all')){
        var sv=await this.fetchStocksTop100('volume');
        if(sv){
          var current=new Set(sv.map(s=>String(s.symbol||'').toUpperCase()));
          sv.forEach(function(s){
            var sym=String(s.symbol||'').toUpperCase();
            if(sym && !self.previousData.stocksVolume.has(sym)){
              newItems.push({
                type:'stock', category:'Stocks Vol', name:s.name, symbol:sym, exchange:s.exchange||'â€”',
                price:Number(s.price||0), volume:Number(s.volume||0), market_cap: Number(s.market_cap || 0), // FIXED colon
                timestamp:new Date().toISOString()
              });
            }
          });
          self.previousData.stocksVolume=current;
        }
      }

      if(this.monitoringOptions.includes('stocks_market_cap') || this.monitoringOptions.includes('all')){
        var sm=await this.fetchStocksTop100('market_cap');
        if(sm){
          var current=new Set(sm.map(s=>String(s.symbol||'').toUpperCase()));
          sm.forEach(function(s){
            var sym=String(s.symbol||'').toUpperCase();
            if(sym && !self.previousData.stocksMarketCap.has(sym)){
              newItems.push({
                type:'stock', category:'Stocks MCap', name:s.name, symbol:sym, exchange:s.exchange||'â€”',
                price:Number(s.price||0), volume:Number(s.volume||0), market_cap: Number(s.market_cap || 0),
                timestamp:new Date().toISOString()
              });
            }
          });
          self.previousData.stocksMarketCap=current;
        }
      }

      if(newItems.length>0){
        Array.prototype.push.apply(this.sevenDayHistory,newItems);
        if(this.sevenDayHistory.length>1000){ this.sevenDayHistory=this.sevenDayHistory.slice(-1000); }
        this.newToday += newItems.length;
        this.updateLiveTracker();
        this.updateStats();
        this.saveData();
        this.log(`âœ… Found ${newItems.length} new item(s)`,'success');
        this.sendNotification(newItems);
      }else{
        this.log('â„¹ï¸ No new items found','info');
      }
    };

    AdvancedMarketMonitor.prototype.sendNotification = function(newItems){
      var email=document.getElementById('email').value;
      if
