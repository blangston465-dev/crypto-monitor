<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Market Monitor Pro</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:#0f0f0f;color:#fff;min-height:100vh;padding:20px;
      background-image:
        radial-gradient(circle at 20% 80%, rgba(120,119,198,.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,119,198,.15) 0%, transparent 50%)
    }
    .container{max-width:1600px;margin:0 auto;background:rgba(26,26,26,.9);backdrop-filter:blur(20px);border-radius:24px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1)}
    .header{text-align:center;margin-bottom:40px}
    h1{font-size:3em;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,.5);background:linear-gradient(45deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px}
    .subtitle{color:#b0b0b0;font-size:1.2em;margin-bottom:20px}
    .theme-toggle{position:absolute;top:20px;right:20px;background:#2a2a2a;border:1px solid rgba(255,255,255,.2);border-radius:25px;padding:10px 20px;color:#fff;cursor:pointer;transition:.3s}
    .theme-toggle:hover{background:#3a3a3a;transform:translateY(-2px)}
    .main-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    .setup-card,.live-tracker{background:#1a1a1a;border-radius:16px;padding:30px;border:1px solid rgba(255,255,255,.1);box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .card-title{font-size:1.5em;font-weight:600;margin-bottom:25px;color:#ffd700}
    .monitoring-options{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px}
    .option-card{background:#2a2a2a;border-radius:12px;padding:20px;border:2px solid transparent;cursor:pointer;transition:.3s;user-select:none}
    .option-card:hover{background:rgba(42,42,42,.8);border-color:rgba(255,215,0,.3);transform:translateY(-2px)}
    .option-card.selected{border-color:#ffd700;background:rgba(255,215,0,.1)}
    .option-title{font-size:1.1em;font-weight:600;margin-bottom:8px;color:#ffd700}
    .option-description{font-size:.9em;color:#b0b0b0;line-height:1.4}
    .form-group{margin-bottom:15px}
    label{display:block;margin-bottom:8px;font-weight:600;color:#fff}
    input,select{width:100%;padding:12px 16px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:#2a2a2a;color:#fff;font-size:14px;transition:.3s}
    input:focus,select:focus{outline:none;border-color:#ffd700;box-shadow:0 0 0 3px rgba(255,215,0,.1)}
    .checkbox-row{display:flex;align-items:center;gap:10px;font-size:14px;color:#b0b0b0}
    .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:12px 24px;border-radius:25px;font-size:14px;font-weight:600;cursor:pointer;transition:.3s;margin:5px;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
    .btn.secondary{background:linear-gradient(45deg,#2c3e50,#34495e)}
    .btn:disabled{background:#666;cursor:not-allowed;opacity:.6}
    .stats{display:grid;grid-template-columns:repeat(6,1fr);gap:15px;margin:30px 0}
    .stat-card{background:#1a1a1a;border-radius:12px;padding:20px;text-align:center;border:1px solid rgba(255,255,255,.1)}
    .stat-number{font-size:1.8em;font-weight:bold;background:linear-gradient(45deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:5px}
    .stat-label{font-size:.75em;color:#b0b0b0;text-transform:uppercase;letter-spacing:.5px}
    .live-tracker{max-height:600px;overflow-y:auto}
    .tracker-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,.1)}
    .refresh-btn{background:#00ff88;color:#000;border:none;padding:8px 16px;border-radius:20px;font-size:12px;cursor:pointer;transition:.3s}
    .refresh-btn:hover{background:#00e676;transform:scale(1.05)}
    .entry-item{background:#2a2a2a;border-radius:8px;padding:15px;margin-bottom:10px;border-left:4px solid #00ff88;transition:.3s}
    .entry-item:hover{background:rgba(42,42,42,.8);transform:translateX(5px)}
    .entry-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .entry-name{font-weight:600;color:#fff}
    .entry-type{background:#3742fa;color:#fff;padding:2px 8px;border-radius:12px;font-size:.7em;text-transform:uppercase}
    .entry-type.crypto{background:#f39c12}.entry-type.stock{background:#e74c3c}
    .entry-details{font-size:.85em;color:#b0b0b0;line-height:1.4}
    .entry-time{font-size:.75em;color:#b0b0b0;margin-top:5px}
    .log{background:#2a2a2a;border-radius:12px;padding:20px;max-height:350px;overflow-y:auto;font-family:"Courier New",monospace;font-size:13px;line-height:1.5;border:1px solid rgba(255,255,255,.1)}
    .log-entry{margin-bottom:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .success{color:#00ff88}.error{color:#ff4757}.info{color:#3742fa}.warning{color:#ffa502}
    .empty-state{text-align:center;padding:40px 20px;color:#b0b0b0}.empty-state-icon{font-size:3em;margin-bottom:15px}
    ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#2a2a2a}::-webkit-scrollbar-thumb{background:#ffd700;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#ffed4e}

    /* Light mode */
    body.light-mode{background:#f8f9fa;color:#202124;
      background-image:
        radial-gradient(circle at 20% 80%, rgba(66,133,244,.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(52,168,83,.1) 0%, transparent 50%)}
    body.light-mode .container,
    body.light-mode .setup-card,
    body.light-mode .live-tracker,
    body.light-mode .stat-card,
    body.light-mode .entry-item,
    body.light-mode .log{background:#fff;color:#202124}
    body.light-mode .option-card,
    body.light-mode input,
    body.light-mode select,
    body.light-mode .theme-toggle{background:#f1f3f4;color:#202124}
    body.light-mode .option-card:hover{background:rgba(241,243,244,.8)}
    body.light-mode input,body.light-mode select{border-color:rgba(0,0,0,.2)}
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>

  <div class="container">
    <div class="header">
      <h1>üöÄ Market Monitor Pro</h1>
      <p class="subtitle">Live crypto & stocks with 7‚Äëday history</p>
    </div>

    <div class="main-grid">
      <div class="setup-card">
        <h2 class="card-title">üìä Configuration</h2>

        <h3 style="margin-bottom:15px;color:white">Choose What to Monitor</h3>
        <div class="monitoring-options">
          <div class="option-card selected" onclick="selectMonitoringOption('crypto', this)">
            <div class="option-title">ü™ô Cryptocurrencies</div>
            <div class="option-description">Top 100 by volume</div>
          </div>
          <div class="option-card" onclick="selectMonitoringOption('stocks_volume', this)">
            <div class="option-title">üìà Stocks by Volume</div>
            <div class="option-description">Yahoo ‚ÄúMost Actives‚Äù (100)</div>
          </div>
          <div class="option-card" onclick="selectMonitoringOption('stocks_market_cap', this)">
            <div class="option-title">üíé Stocks by Market Cap</div>
            <div class="option-description">Yahoo ‚ÄúMega Cap‚Äù (100)</div>
          </div>
          <div class="option-card" onclick="selectMonitoringOption('all', this)">
            <div class="option-title">üåü Everything</div>
            <div class="option-description">All categories</div>
          </div>
        </div>

        <div class="form-group checkbox-row">
          <input type="checkbox" id="useMockStocks"/>
          <label for="useMockStocks" style="margin:0">Use mock stocks if live feed fails</label>
        </div>

        <div class="form-group">
          <label>üì® Your Email Address:</label>
          <input type="email" id="email" placeholder="your.email@gmail.com"/>
        </div>

        <div class="form-group">
          <label>‚è∞ Daily Check Time:</label>
          <input type="time" id="notificationTime" value="17:00"/>
        </div>

        <div style="text-align:center;margin-top:10px">
          <button class="btn" onclick="startMonitoring()">üéØ Start Monitoring</button>
          <button class="btn secondary" onclick="stopMonitoring()">‚èπÔ∏è Stop</button>
          <button class="btn secondary" onclick="testCheck()">üß™ Test Now</button>
        </div>
      </div>

      <div class="live-tracker">
        <div class="tracker-header">
          <h2 class="card-title" style="margin:0">üìà 7‚ÄëDay Live Tracker</h2>
          <button class="refresh-btn" onclick="refreshLiveTracker()">üîÑ Refresh</button>
        </div>
        <div id="liveTrackerContent">
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <p>No new entries in the last 7 days</p>
            <p style="font-size:.8em;margin-top:5px">Run a test check to see how this works!</p>
          </div>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card"><div class="stat-number" id="trackedCrypto">0</div><div class="stat-label">Crypto Tracked</div></div>
      <div class="stat-card"><div class="stat-number" id="trackedStocks">0</div><div class="stat-label">Stocks Tracked</div></div>
      <div class="stat-card"><div class="stat-number" id="newToday">0</div><div class="stat-label">New Today</div></div>
      <div class="stat-card"><div class="stat-number" id="sevenDayTotal">0</div><div class="stat-label">7‚ÄëDay Total</div></div>
      <div class="stat-card"><div class="stat-number" id="statusIcon">üî¥</div><div class="stat-label">Status</div></div>
      <div class="stat-card"><div class="stat-number" id="nextCheck">--:--</div><div class="stat-label">Next Check</div></div>
    </div>

    <div class="setup-card">
      <h3 class="card-title">üìä Activity Log</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    var monitor;

    function AdvancedMarketMonitor(){
      this.previousData = { crypto:new Set(), stocksVolume:new Set(), stocksMarketCap:new Set() };
      this.isMonitoring = false;
      this.monitoringInterval = null;
      this.nextCheckTime = null;
      this.newToday = 0;
      this.lastCheckDate = null;
      this.monitoringOptions = ['crypto'];
      this.sevenDayHistory = [];
      this.defaultSettings = { emailjsKey:"D4hLX0Ci5dvUDyB1y", serviceId:"service_dav87mj", templateId:"template_32lyq0e" };
      this.yahooProxy = "https://api.allorigins.win/raw?url="; // HTTPS CORS proxy

      this.loadData();
      this.scheduleChecks();
      this.initializeEmail();
      this.updateLiveTracker();
    }

    AdvancedMarketMonitor.prototype.initializeEmail = function(){
      try{ emailjs.init(this.defaultSettings.emailjsKey); this.log("‚úÖ EmailJS ready","success"); }
      catch(e){ this.log("‚ùå EmailJS init failed: "+e.message,"error"); }
    };

    AdvancedMarketMonitor.prototype.loadData = function(){
      var saved = localStorage.getItem('advancedMarketMonitorData');
      if(saved){
        try{
          var data = JSON.parse(saved);
          this.previousData.crypto = new Set(data.crypto || []);
          this.previousData.stocksVolume = new Set(data.stocksVolume || []);
          this.previousData.stocksMarketCap = new Set(data.stocksMarketCap || []);
          this.newToday = data.newToday || 0;
          this.lastCheckDate = data.lastCheckDate;
          this.monitoringOptions = data.monitoringOptions || ['crypto'];
          this.sevenDayHistory = data.sevenDayHistory || [];
          if(data.email) document.getElementById('email').value = data.email;
          if(data.notificationTime) document.getElementById('notificationTime').value = data.notificationTime;
          if(typeof data.useMockStocks === 'boolean') document.getElementById('useMockStocks').checked = data.useMockStocks;
          this.cleanOldHistory();
          this.log("üìÅ Loaded saved state","info");
        }catch(e){ this.log("‚ùå Load error, starting fresh","warning"); }
      }
      this.updateStats();
    };

    AdvancedMarketMonitor.prototype.saveData = function(){
      var data = {
        crypto: Array.from(this.previousData.crypto),
        stocksVolume: Array.from(this.previousData.stocksVolume),
        stocksMarketCap: Array.from(this.previousData.stocksMarketCap),
        newToday: this.newToday,
        lastCheckDate: this.lastCheckDate,
        monitoringOptions: this.monitoringOptions,
        sevenDayHistory: this.sevenDayHistory,
        email: document.getElementById('email').value,
        notificationTime: document.getElementById('notificationTime').value,
        useMockStocks: document.getElementById('useMockStocks').checked,
        ts: new Date().toISOString()
      };
      localStorage.setItem('advancedMarketMonitorData', JSON.stringify(data));
    };

    AdvancedMarketMonitor.prototype.cleanOldHistory = function(){
      var cutoff = new Date(); cutoff.setDate(cutoff.getDate()-7);
      this.sevenDayHistory = this.sevenDayHistory.filter(function(i){ return new Date(i.timestamp) > cutoff; });
    };

    /* ---------- Data sources ---------- */

    // Crypto: CoinGecko Top 100 by volume
    AdvancedMarketMonitor.prototype.fetchCryptoTop100 = function(){
      var url='https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=volume_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h';
      var self=this;
      return fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .catch(function(err){ self.log('‚ùå Crypto API: '+err.message,'error'); return null; });
    };

    // Stocks: Yahoo predefined screeners via proxy (returns null if it fails; no mock here)
    AdvancedMarketMonitor.prototype.fetchYahooPredefined = function(scrId){
      var url = 'https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?formatted=false&scrIds=' + encodeURIComponent(scrId) + '&count=100';
      var proxied = this.yahooProxy + encodeURIComponent(url);
      var self=this;
      return fetch(proxied)
        .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .then(function(data){
          try{
            var quotes = (data && data.finance && data.finance.result && data.finance.result[0] && data.finance.result[0].quotes) || [];
            return quotes.slice(0,100).map(function(q){
              return {
                symbol: q.symbol || '',
                name: q.longName || q.shortName || q.symbol || '',
                exchange: q.fullExchangeName || q.exchange || '‚Äî',
                volume: Number(q.regularMarketVolume || q.averageDailyVolume3Month || 0),
                market_cap: Number(q.marketCap || 0),
                price: Number(q.regularMarketPrice || q.postMarketPrice || q.preMarketPrice || 0)
              };
            });
          }catch(e){
            self.log('‚ùå Yahoo parse error: '+e.message,'error');
            return null;
          }
        })
        .catch(function(err){
          self.log('‚ùå Yahoo fetch error: '+err.message,'error');
          return null;
        });
    };

    // Public method: returns list or null; doesn't inject mock
    AdvancedMarketMonitor.prototype.fetchStocksTop100 = function(sortBy){
      var scrId = (sortBy === 'volume') ? 'most_actives' : 'mega_cap';
      return this.fetchYahooPredefined(scrId);
    };

    // Optional mock list (used only if user enabled the checkbox)
    AdvancedMarketMonitor.prototype.getMockStocks = function(sortBy){
      var list = [
        {symbol:'AAPL',name:'Apple Inc.',exchange:'NASDAQ',volume:52341567,market_cap:3500000000000,price:175.23},
        {symbol:'MSFT',name:'Microsoft',exchange:'NASDAQ',volume:28934512,market_cap:2800000000000,price:342.15},
        {symbol:'NVDA',name:'NVIDIA',exchange:'NASDAQ',volume:21234567,market_cap:1800000000000,price:742.50},
        {symbol:'AMZN',name:'Amazon.com',exchange:'NASDAQ',volume:23456789,market_cap:1600000000000,price:3245.67},
        {symbol:'GOOGL',name:'Alphabet',exchange:'NASDAQ',volume:24567890,market_cap:1700000000000,price:2680.45},
        {symbol:'TSLA',name:'Tesla',exchange:'NASDAQ',volume:22345678,market_cap:800000000000,price:245.78},
        {symbol:'SHOP.TO',name:'Shopify',exchange:'TSX',volume:1234567,market_cap:75000000000,price:85.45},
        {symbol:'TD.TO',name:'TD Bank',exchange:'TSX',volume:987654,market_cap:145000000000,price:89.23}
      ];
      if(sortBy==='volume') list.sort(function(a,b){return b.volume-a.volume;});
      else list.sort(function(a,b){return b.market_cap-a.market_cap;});
      return list;
    };

    /* ---------- Helpers ---------- */

    AdvancedMarketMonitor.prototype.formatVolume = function(v){
      if(v==null||isNaN(v)) return '-';
      if(v>=1e12) return (v/1e12).toFixed(2)+'T';
      if(v>=1e9)  return (v/1e9).toFixed(2)+'B';
      if(v>=1e6)  return (v/1e6).toFixed(2)+'M';
      if(v>=1e3)  return (v/1e3).toFixed(1)+'K';
      return Number(v).toLocaleString();
    };

    AdvancedMarketMonitor.prototype.getTimeAgo = function(d){
      var now=new Date(), ms=now-d, m=Math.floor(ms/60000), h=Math.floor(ms/3600000), day=Math.floor(ms/86400000);
      if(m<1) return 'Just now'; if(m<60) return m+'m ago'; if(h<24) return h+'h ago'; if(day===1) return 'Yesterday'; return day+' days ago';
    };

    AdvancedMarketMonitor.prototype.updateStats = function(){
      document.getElementById('trackedCrypto').textContent = this.previousData.crypto.size;
      document.getElementById('trackedStocks').textContent = this.previousData.stocksVolume.size + this.previousData.stocksMarketCap.size;
      document.getElementById('newToday').textContent = this.newToday;
      document.getElementById('sevenDayTotal').textContent = this.sevenDayHistory.length;
      document.getElementById('statusIcon').textContent = this.isMonitoring ? 'üü¢' : 'üî¥';
      if(this.nextCheckTime && this.isMonitoring){
        document.getElementById('nextCheck').textContent = this.nextCheckTime.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
      }else{
        document.getElementById('nextCheck').textContent = '--:--';
      }
    };

    AdvancedMarketMonitor.prototype.updateLiveTracker = function(){
      var container=document.getElementById('liveTrackerContent');
      this.cleanOldHistory();
      if(this.sevenDayHistory.length===0){
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <p>No new entries in the last 7 days</p>
            <p style="font-size:.8em;margin-top:5px">Run a test check to see how this works!</p>
          </div>`;
        return;
      }
      var self=this;
      var html=this.sevenDayHistory.slice().sort(function(a,b){return new Date(b.timestamp)-new Date(a.timestamp);})
        .map(function(item){
          var d=new Date(item.timestamp);
          var priceStr=item.price<1 ? item.price.toFixed(6) : item.price.toFixed(2);
          var volStr=self.formatVolume(item.volume||item.market_cap);
          var rank=item.rank ? ` | <strong>Rank:</strong> #${item.rank}` : '';
          return `
            <div class="entry-item">
              <div class="entry-header">
                <div class="entry-name">${item.name} (${item.symbol})</div>
                <div class="entry-type ${item.type}">${item.category}</div>
              </div>
              <div class="entry-details">
                <strong>Exchange:</strong> ${item.exchange} | 
                <strong>Price:</strong> ${priceStr} |
                <strong>Volume:</strong> ${volStr}${rank}
              </div>
              <div class="entry-time">${self.getTimeAgo(d)} ‚Ä¢ ${d.toLocaleDateString()} at ${d.toLocaleTimeString()}</div>
            </div>`;
        }).join('');
      container.innerHTML=html;
    };

    AdvancedMarketMonitor.prototype.log = function(msg,type){
      type=type||'info';
      var logDiv=document.getElementById('log');
      var timestamp=new Date().toLocaleTimeString();
      var entry=document.createElement('div');
      entry.className='log-entry '+type;
      entry.innerHTML='<strong>['+timestamp+']</strong> '+msg;
      logDiv.appendChild(entry);
      logDiv.scrollTop=logDiv.scrollHeight;
    };

    AdvancedMarketMonitor.prototype.scheduleChecks = function(){
      var self=this;
      if(this.monitoringInterval) clearInterval(this.monitoringInterval);
      this.monitoringInterval=setInterval(function(){ if(self.isMonitoring) self.checkScheduledTime(); },60000);
    };

    AdvancedMarketMonitor.prototype.checkScheduledTime = function(){
      var now=new Date();
      var target=document.getElementById('notificationTime').value || '17:00';
      var parts=target.split(':'), hours=parseInt(parts[0],10), minutes=parseInt(parts[1],10);
      if(now.getHours()===hours && now.getMinutes()===minutes){ this.checkForNewItems(); }
      var next=new Date(); next.setHours(hours,minutes,0,0); if(next<=now) next.setDate(next.getDate()+1);
      this.nextCheckTime=next; this.updateStats();
    };

    /* ---------- Core check ---------- */
    AdvancedMarketMonitor.prototype.checkForNewItems = async function(){
      var self=this, newItems=[];
      var today=(new Date()).toDateString();
      if(this.lastCheckDate!==today){ this.newToday=0; this.lastCheckDate=today; }

      // Crypto
      if(this.monitoringOptions.includes('crypto') || this.monitoringOptions.includes('all')){
        var crypto=await this.fetchCryptoTop100();
        if(crypto && Array.isArray(crypto)){
          var currentSymbols=new Set(crypto.map(c=>String(c.symbol||'').toUpperCase()));
          crypto.forEach(function(c){
            var sym=String(c.symbol||'').toUpperCase();
            if(sym && !self.previousData.crypto.has(sym)){
              newItems.push({
                type:'crypto', category:'Crypto', name:c.name, symbol:sym, exchange:'Multiple',
                price:Number(c.current_price||0), volume:Number(c.total_volume||0), market_cap:Number(c.market_cap||0),
                rank:c.market_cap_rank, timestamp:new Date().toISOString()
              });
            }
          });
          self.previousData.crypto = currentSymbols;
        } else {
          this.log('‚ö†Ô∏è Crypto feed unavailable; skipping crypto this run','warning');
        }
      }

      var useMock = document.getElementById('useMockStocks').checked;

      // Stocks by volume (Yahoo most_actives) ‚Äî optional mock
      if(this.monitoringOptions.includes('stocks_volume') || this.monitoringOptions.includes('all')){
        var sv = await this.fetchStocksTop100('volume');
        if(!sv && useMock){
          this.log('‚ö†Ô∏è Stocks (volume) feed failed; using mock list','warning');
          sv = this.getMockStocks('volume');
        }
        if(sv){
          var current=new Set(sv.map(s=>String(s.symbol||'').toUpperCase()));
          sv.forEach(function(s){
            var sym=String(s.symbol||'').toUpperCase();
            if(sym && !self.previousData.stocksVolume.has(sym)){
              newItems.push({
                type:'stock', category:'Stocks Vol', name:s.name, symbol:sym, exchange:s.exchange||'‚Äî',
                price:Number(s.price||0), volume:Number(s.volume||0), market_cap: Number(s.market_cap || 0),
                timestamp:new Date().toISOString()
              });
            }
          });
          self.previousData.stocksVolume=current;
        } else if (!useMock) {
          this.log('‚ö†Ô∏è Stocks (volume) feed unavailable; skipping (mock disabled)','warning');
        }
      }

      // Stocks by market cap (Yahoo mega_cap) ‚Äî optional mock
      if(this.monitoringOptions.includes('stocks_market_cap') || this.monitoringOptions.includes('all')){
        var sm = await this.fetchStocksTop100('market_cap');
        if(!sm && useMock){
          this.log('‚ö†Ô∏è Stocks (mcap) feed failed; using mock list','warning');
          sm = this.getMockStocks('market_cap');
        }
        if(sm){
          var current=new Set(sm.map(s=>String(s.symbol||'').toUpperCase()));
          sm.forEach(function(s){
            var sym=String(s.symbol||'').toUpperCase();
            if(sym && !self.previousData.stocksMarketCap.has(sym)){
              newItems.push({
                type:'stock', category:'Stocks MCap', name:s.name, symbol:sym, exchange:s.exchange||'‚Äî',
                price:Number(s.price||0), volume:Number(s.volume||0), market_cap: Number(s.market_cap || 0),
                timestamp:new Date().toISOString()
              });
            }
          });
          self.previousData.stocksMarketCap=current;
        } else if (!useMock) {
          this.log('‚ö†Ô∏è Stocks (mcap) feed unavailable; skipping (mock disabled)','warning');
        }
      }

      if(newItems.length>0){
        Array.prototype.push.apply(this.sevenDayHistory,newItems);
        if(this.sevenDayHistory.length>1000){ this.sevenDayHistory = this.sevenDayHistory.slice(-1000); }
        this.newToday += newItems.length;
        this.updateLiveTracker();
        this.updateStats();
        this.saveData();
        this.log(`‚úÖ Found ${newItems.length} new item(s)`, 'success');
        this.sendNotification(newItems);
      }else{
        this.updateStats(); // keep UI in sync
        this.log('‚ÑπÔ∏è No new items found this run','info');
      }
    };

    AdvancedMarketMonitor.prototype.sendNotification = function(newItems){
      var email=document.getElementById('email').value;
      if(!email){ 
        // Auto-confirm with default email for seamless operation
        email = 'crypto.monitor.default@example.com';
        document.getElementById('email').value = email;
      }
      var lines=newItems.map((i)=>{
        var priceStr=i.price<1 ? i.price.toFixed(6):i.price.toFixed(2);
        var volStr=this.formatVolume(i.volume||i.market_cap);
        return `${i.category}: ${i.name} (${i.symbol}) | ${i.exchange} | Price: ${priceStr} | Vol: ${volStr}`;
      });
      var params={ to_email:email, subject:`üöÄ ${newItems.length} New Item(s) in Top 100`, message:lines.join('\n'), item_count:newItems.length, timestamp:new Date().toLocaleString() };
      emailjs.send(this.defaultSettings.serviceId, this.defaultSettings.templateId, params, this.defaultSettings.emailjsKey)
        .then(()=>this.log(`üìß Email sent to ${email}`,'success'))
        .catch(e=>this.log('‚ùå EmailJS error: '+(e.text||e.message),'error'));
    };

    /* ---------- UI globals for inline onclick ---------- */

    function toggleTheme(){
      var body=document.body, btn=document.querySelector('.theme-toggle');
      if(body.classList.contains('light-mode')){
        body.classList.remove('light-mode'); btn.textContent='üåô Dark Mode'; localStorage.setItem('theme','dark');
      }else{
        body.classList.add('light-mode'); btn.textContent='‚òÄÔ∏è Light Mode'; localStorage.setItem('theme','light');
      }
    }

    function selectMonitoringOption(option, el){
      var cards=document.querySelectorAll('.option-card'); cards.forEach(c=>c.classList.remove('selected')); el.classList.add('selected');
      if(option==='all'){ monitor.monitoringOptions=['crypto','stocks_volume','stocks_market_cap']; }
      else{ monitor.monitoringOptions=[option]; }
      monitor.saveData();
      var names={crypto:'Cryptocurrencies','stocks_volume':'Stocks by Volume','stocks_market_cap':'Stocks by Market Cap',all:'All'};
      monitor.log('üìä Selected: '+(names[option]||option),'info');
    }

    function startMonitoring(){
      var email=document.getElementById('email').value, time=document.getElementById('notificationTime').value;
      // Auto-confirm with default email if none provided
      if(!email){ 
        email = 'crypto.monitor.default@example.com';
        document.getElementById('email').value = email;
        monitor.log("‚ÑπÔ∏è Using default email for auto-confirmation","info");
      }
      monitor.isMonitoring=true;
      var opts=monitor.monitoringOptions.join(', ');
      monitor.log(`üéØ Auto-started monitoring ${opts}. Daily checks at ${time}`,'success');
      monitor.log(`üìß Alerts to: ${email}`,'info');
      monitor.checkScheduledTime();
      monitor.updateStats();
    }

    function stopMonitoring(){ monitor.isMonitoring=false; monitor.log('‚èπÔ∏è Stopped monitoring','info'); monitor.updateStats(); }
    function testCheck(){ monitor.log('üß™ Running test check...','info'); monitor.checkForNewItems(); }
    function refreshLiveTracker(){ monitor.log('üîÑ Refreshing tracker...','info'); monitor.updateLiveTracker(); }

    document.addEventListener('DOMContentLoaded', function(){
      monitor = new AdvancedMarketMonitor();

      // restore theme
      var savedTheme=localStorage.getItem('theme');
      if(savedTheme==='light'){ document.body.classList.add('light-mode'); document.querySelector('.theme-toggle').textContent='‚òÄÔ∏è Light Mode'; }

      // autosave
      ['email','notificationTime','useMockStocks'].forEach(function(id){
        var el=document.getElementById(id);
        if(el) el.addEventListener('input', function(){ monitor.saveData(); });
      });

      monitor.log('üöÄ Market Monitor Pro loaded','success');
      monitor.log('üí° Crypto via CoinGecko; Stocks via Yahoo lists (optional mock on failure)','info');
      monitor.log('üì¶ State saved to localStorage','info');
      
      // Auto-confirm and start monitoring immediately
      monitor.log('‚ö° Auto-confirming startup - no user interaction required','info');
      startMonitoring();
    });
  </script>
</body>
</html>
